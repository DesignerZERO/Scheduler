<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진료 스케줄러 v5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #2c3744;
            overflow: hidden;
        }

        .scheduler-container {
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: flex;
            position: relative;
        }

        /* 좌측 사이드바 */
        .left-sidebar {
            width: 280px;
            height: 100vh;
            background: #ffffff;
            border-right: 1px solid #e5e8eb;
            display: flex;
            flex-direction: column;
        }

        /* 병원명 헤더 */
        .clinic-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e8eb;
        }

        .clinic-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3744;
            margin-bottom: 4px;
        }

        /* 캘린더 영역 */
        .calendar-section {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e8eb;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            position: relative;
        }

        .calendar-nav {
            position: absolute;
            font-size: 16px;
            cursor: pointer;
            color: #666;
        }

        .calendar-nav.prev {
            left: 0;
        }

        .calendar-nav.next {
            right: 0;
        }

        .calendar-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3744;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e8eb;
            border: 1px solid #e5e8eb;
        }

        .calendar-day-header {
            background: #f8f9fa;
            padding: 6px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        .calendar-day {
            background: #ffffff;
            padding: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #f0f7ff;
        }

        .calendar-day.selected {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            font-weight: 700;
            color: #ff6b6b;
        }

        /* 진료항목 섹션 */
        .treatment-section {
            flex: 1;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }

        .treatment-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f4;
        }

        .treatment-item:last-child {
            border-bottom: none;
        }

        .treatment-radio {
            width: 16px;
            height: 16px;
            border: 2px solid #d4d9dc;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .treatment-radio.selected {
            border-color: #1976d2;
            background: #1976d2;
        }

        .treatment-radio.selected::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .treatment-info {
            flex: 1;
        }

        .treatment-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3744;
            margin-bottom: 2px;
        }

        .treatment-desc {
            font-size: 12px;
            color: #666;
        }

        /* 진료 유형 색상 범례 */
        .treatment-legend {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e5e8eb;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .legend-color.general {
            background: #42a5f5;
        }

        .legend-color.pediatric {
            background: #ec407a;
        }

        .legend-color.seasonal {
            background: #bdbdbd;
        }

        .legend-text {
            font-size: 11px;
            color: #666;
        }

        /* 하단 설정 영역 */
        .bottom-settings {
            padding: 16px 20px;
            border-top: 1px solid #e5e8eb;
        }

        .setting-group {
            margin-bottom: 12px;
        }

        .setting-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .setting-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .setting-buttons {
            display: flex;
            gap: 6px;
        }

        .setting-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .setting-btn:hover {
            background: #f8f9fa;
        }

        /* 메인 스케줄 영역 */
        .main-schedule {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        /* 주간 헤더 */
        .week-header {
            height: 100px;
            background: #ffffff;
            border-bottom: 1px solid #e5e8eb;
            display: flex;
            flex-direction: column;
        }

        .week-info {
            padding: 16px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .week-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3744;
        }

        .week-range {
            font-size: 12px;
            color: #666;
        }

        .date-headers {
            display: flex;
            height: 60px;
            border-top: 1px solid #e5e8eb;
        }

        .time-column-header {
            width: 80px;
            background: #f8f9fa;
            border-right: 1px solid #e5e8eb;
        }

        .date-column {
            flex: 1;
            border-right: 1px solid #e5e8eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .date-column:last-child {
            border-right: none;
        }

        .date-number {
            font-size: 20px;
            font-weight: 700;
            color: #2c3744;
            margin-bottom: 2px;
        }

        .date-day {
            font-size: 11px;
            color: #666;
        }

        .date-column.today .date-number {
            color: #ff6b6b;
        }

        .date-column.weekend .date-number {
            color: #1976d2;
        }

        /* 스케줄 그리드 영역 */
        .schedule-content {
            flex: 1;
            display: flex;
            overflow-y: auto;
            position: relative;
        }

        .time-column {
            width: 80px;
            background: #f8f9fa;
            border-right: 1px solid #e5e8eb;
            position: relative;
        }

        .time-slot {
            height: 60px; /* 30분 = 60px (5분=10px 기준) */
            border-bottom: 1px solid #e5e8eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            position: relative;
        }

        .schedule-grid {
            flex: 1;
            display: flex;
            position: relative;
        }

        .day-column {
            flex: 1;
            border-right: 1px solid #e5e8eb;
            position: relative;
            min-height: 100%;
        }

        .day-column:last-child {
            border-right: none;
        }

        .hour-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hour-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: #e5e8eb;
        }

        .five-minute-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: #f0f2f4;
        }

        /* 5분 단위 스케줄 블록 */
        .schedule-block {
            position: absolute;
            left: 6px;
            right: 6px;
            height: 10px;
            border-radius: 8px;
            z-index: 10;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            box-shadow: 0 -1px 0 0 rgba(0, 0, 0, 0.08) inset;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 4px;
            transition: all 0.2s ease;
        }

        .schedule-block.general {
            background: #64b5f6;
            border-color: #1976d2;
        }

        .schedule-block.pediatric {
            background: #f48fb1 ;
            border-color: #c2185b;
        }

        .schedule-block.seasonal {
            background: #bdbdbd;
            border-color: #757575;
        }

        .schedule-block:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 20;
            transition: all 0.2s ease;
        }

        /* 하단 액션 버튼 */
        .action-footer {
            height: 70px;
            background: #ffffff;
            border-top: 1px solid #e5e8eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }

        .footer-left {
            display: flex;
            gap: 12px;
        }

        .footer-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .footer-btn.outline {
            background: #ffffff;
            border: 1px solid #ddd;
            color: #666;
        }

        .footer-btn.cancel {
            background: #ffffff;
            border: 1px solid #ddd;
            color: #666;
        }

        .footer-btn.save {
            background: #ffeb3b;
            border: none;
            color: #2c3744;
        }

        .footer-btn:hover {
            opacity: 0.9;
        }

        /* 드래그 관련 스타일 */
        .drag-preview {
            position: absolute;
            background: rgba(46, 125, 50, 0.3);
            border: 1px dashed #2e7d32;
            border-radius: 2px;
            z-index: 15;
            pointer-events: none;
        }

        .delete-drag-preview {
            position: absolute;
            background: rgba(255, 68, 68, 0.3);
            border: 2px dashed #ff4444;
            border-radius: 2px;
            z-index: 15;
            pointer-events: none;
            animation: deletePreviewPulse 1s ease-in-out infinite alternate;
        }

        @keyframes deletePreviewPulse {
            0% {
                background: rgba(255, 68, 68, 0.2);
                border-color: #ff6666;
            }
            100% {
                background: rgba(255, 68, 68, 0.4);
                border-color: #ff2222;
            }
        }

        @keyframes errorPulse {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        /* 팝업 스타일 */
        .appointment-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            overflow: hidden;
        }

        .popup-header {
            padding: 20px;
        }

        .popup-title {
            font-size: 16px;
            font-weight: 700;
            color: #2c3744;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #2c3744;
            margin-bottom: 6px;
            display: block;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
        }

        .popup-actions {
            padding: 16px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #e5e8eb;
        }

        .popup-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .popup-btn.cancel {
            background: #f8f9fa;
            color: #666;
        }

        .popup-btn.save {
            background: #1976d2;
            color: white;
        }

        /* 멀티 블럭 생성 스타일 */
        .multi-drag-preview {
            position: absolute;
            background: rgba(66, 165, 245, 0.3);
            border: 1px dashed #1976d2;
            border-radius: 2px;
            z-index: 20;
            pointer-events: none;
        }

        /* 호버 프리뷰 스타일 */
        .hover-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            background: rgba(128, 128, 128, 0.4);
            border: 1px solid #999;
            border-radius: 2px;
            z-index: 5;
            pointer-events: none;
            opacity: 0.7;
        }

        /* 커서 스타일 */
        .cursor-create {
            cursor: crosshair !important;
        }

        .cursor-move {
            cursor: move !important;
        }

        .cursor-delete {
            cursor: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjZmY0NDQ0IiBkPSJNNiAyMWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djE0ek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDVjLS42IDAtMSAuNC0xIDF2MWMwIC42LjQgMSAxIDFoMTRjLjYgMCAxLS40IDEtMVY1YzAtLjYtLjQtMS0xLTF6Ii8+PC9zdmc+') 12 12, auto !important;
        }

        .cursor-default {
            cursor: default !important;
        }

        /* 각 요소별 기본 커서 오버라이드 */
        .day-column {
            /* 기본 커서는 JavaScript에서 설정 */
        }

        .day-column.delete-mode {
            cursor: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjZmY0NDQ0IiBkPSJNNiAyMWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djE0ek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDVjLS42IDAtMSAuNC0xIDF2MWMwIC42LjQgMSAxIDFoMTRjLjYgMCAxLS40IDEtMVY1YzAtLjYtLjQtMS0xLTF6Ii8+PC9zdmc+') 12 12, auto;
        }

        .schedule-block {
            /* 기본 커서는 JavaScript에서 설정 */
        }

        .schedule-block.delete-mode {
            cursor: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjZmY0NDQ0IiBkPSJNNiAyMWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djE0ek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDVjLS42IDAtMSAuNC0xIDF2MWMwIC42LjQgMSAxIDFoMTRjLjYgMCAxLS40IDEtMVY1YzAtLjYtLjQtMS0xLTF6Ii8+PC9zdmc+') 12 12, auto;
        }
    </style>
</head>
<body>
    <div class="scheduler-container">
        <!-- 좌측 사이드바 -->
        <div class="left-sidebar">
            <!-- 병원명 헤더 -->
            <div class="clinic-header">
                <div class="clinic-name">[김똑닥진료실/소아청소년과]</div>
            </div>

            <!-- 캘린더 -->
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-nav prev">‹</div>
                    <div class="calendar-title">2025년 9월</div>
                    <div class="calendar-nav next">›</div>
                </div>
                
                <div class="calendar-grid">
                    <div class="calendar-day-header">일</div>
                    <div class="calendar-day-header">월</div>
                    <div class="calendar-day-header">화</div>
                    <div class="calendar-day-header">수</div>
                    <div class="calendar-day-header">목</div>
                    <div class="calendar-day-header">금</div>
                    <div class="calendar-day-header">토</div>
                    
                    <div class="calendar-day other-month">31</div>
                    <div class="calendar-day">1</div>
                    <div class="calendar-day">2</div>
                    <div class="calendar-day">3</div>
                    <div class="calendar-day">4</div>
                    <div class="calendar-day">5</div>
                    <div class="calendar-day">6</div>
                    
                    <div class="calendar-day">7</div>
                    <div class="calendar-day">8</div>
                    <div class="calendar-day">9</div>
                    <div class="calendar-day">10</div>
                    <div class="calendar-day">11</div>
                    <div class="calendar-day">12</div>
                    <div class="calendar-day">13</div>
                    
                    <div class="calendar-day">14</div>
                    <div class="calendar-day">15</div>
                    <div class="calendar-day">16</div>
                    <div class="calendar-day selected">17</div>
                    <div class="calendar-day">18</div>
                    <div class="calendar-day">19</div>
                    <div class="calendar-day">20</div>
                    
                    <div class="calendar-day">21</div>
                    <div class="calendar-day">22</div>
                    <div class="calendar-day today">23</div>
                    <div class="calendar-day">24</div>
                    <div class="calendar-day">25</div>
                    <div class="calendar-day">26</div>
                    <div class="calendar-day">27</div>
                    
                    <div class="calendar-day">28</div>
                    <div class="calendar-day">29</div>
                    <div class="calendar-day">30</div>
                    <div class="calendar-day other-month">1</div>
                    <div class="calendar-day other-month">2</div>
                    <div class="calendar-day other-month">3</div>
                    <div class="calendar-day other-month">4</div>
                </div>
            </div>

            <!-- 진료항목 선택 -->
            <div class="treatment-section">
                <div class="section-title">추가 기능 입력 +</div>
                
                <div class="treatment-item" data-treatment="general">
                    <div class="treatment-radio selected"></div>
                    <div class="treatment-info">
                        <div class="treatment-name">일반진료</div>
                        <div class="treatment-desc">5분</div>
                    </div>
                </div>
                
                <div class="treatment-item" data-treatment="pediatric">
                    <div class="treatment-radio"></div>
                    <div class="treatment-info">
                        <div class="treatment-name">영유아검진</div>
                        <div class="treatment-desc">15분</div>
                    </div>
                </div>
                
                <div class="treatment-item" data-treatment="delete">
                    <div class="treatment-radio"></div>
                    <div class="treatment-info">
                        <div class="treatment-name">삭제</div>
                        <div class="treatment-desc">블럭 삭제</div>
                    </div>
                </div>

                <!-- 진료 유형 범례 -->
                <div class="treatment-legend">
                    <div class="legend-item">
                        <div class="legend-color general"></div>
                        <span class="legend-text">일반진료 5분</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color pediatric"></div>
                        <span class="legend-text">영유아검진 15분</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color seasonal"></div>
                        <span class="legend-text">삭제 모드</span>
                    </div>
                </div>
            </div>

            <!-- 하단 설정 -->
            <div class="bottom-settings">
                <div class="setting-group">
                    <div class="setting-label">진료명</div>
                    <input type="text" class="setting-input" placeholder="진료 내용 입력">
                </div>
                
                <div class="setting-buttons">
                    <button class="setting-btn">문턱하기</button>
                    <button class="setting-btn">저장하기</button>
                </div>
            </div>
        </div>

        <!-- 메인 스케줄 영역 -->
        <div class="main-schedule">
            <!-- 주간 헤더 -->
            <div class="week-header">
                <div class="week-info">
                    <div>
                        <div class="week-title">9월 17일 ~ 23일</div>
                        <div class="week-range">예약 가능 인원 수: 120명</div>
                    </div>
                </div>
                
                <div class="date-headers">
                    <div class="time-column-header"></div>
                    <div class="date-column">
                        <div class="date-number">17</div>
                        <div class="date-day">월</div>
                    </div>
                    <div class="date-column">
                        <div class="date-number">18</div>
                        <div class="date-day">화</div>
                    </div>
                    <div class="date-column">
                        <div class="date-day">수</div>
                        <div class="date-number">19</div>
                    </div>
                    <div class="date-column">
                        <div class="date-number">20</div>
                        <div class="date-day">목</div>
                    </div>
                    <div class="date-column">
                        <div class="date-number">21</div>
                        <div class="date-day">금</div>
                    </div>
                    <div class="date-column weekend">
                        <div class="date-number">22</div>
                        <div class="date-day">토</div>
                    </div>
                    <div class="date-column today">
                        <div class="date-number">23</div>
                        <div class="date-day">일</div>
                    </div>
                </div>
            </div>

            <!-- 스케줄 컨텐츠 -->
            <div class="schedule-content">
                <!-- 시간 컬럼 -->
                <div class="time-column" id="timeColumn">
                    <!-- 시간 슬롯들이 동적으로 생성됩니다 -->
                </div>

                <!-- 스케줄 그리드 -->
                <div class="schedule-grid">
                    <!-- 각 요일별 컬럼 -->
                    <div class="day-column" data-day="0">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="1">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="2">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="3">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="4">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="5">
                        <div class="hour-lines"></div>
                    </div>
                    
                    <div class="day-column" data-day="6">
                        <div class="hour-lines"></div>
                    </div>
                </div>
            </div>

            <!-- 하단 액션 버튼 -->
            <div class="action-footer">
                <div class="footer-left">
                    <button class="footer-btn outline">미리보기</button>
                </div>
                <div>
                    <button class="footer-btn cancel">취소</button>
                    <button class="footer-btn save">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let isDragging = false;
        let dragStartY = 0;
        let currentColumn = null;
        let dragPreview = null;
        let hasMoved = false;
        let selectedTreatment = 'general'; // 기본 선택: 일반진료
        let isMovingBlock = false;
        let movingBlock = null;
        let hoverPreview = null;

        // 치료 유형 정보
        const treatmentTypes = {
            general: { name: '일반진료', duration: 5, height: 10, color: 'general' },
            pediatric: { name: '영유아검진', duration: 15, height: 30, color: 'pediatric' },
            delete: { name: '삭제', duration: 0, height: 0, color: 'seasonal' }
        };

        // 위치 스냅핑 (생성/이동 시 시작점) - 항상 5분 단위 (10px)
        function snapToPosition(pixels) {
            return Math.round(pixels / 10) * 10;
        }
        
        // 크기 스냅핑 (블럭 높이) - 치료 유형에 따라
        function snapToTreatmentSize(pixels) {
            const treatment = treatmentTypes[selectedTreatment];
            if (selectedTreatment === 'delete') {
                return Math.round(pixels / 10) * 10; // 삭제 모드는 기본 10px 단위
            }
            const snapSize = treatment.height;
            return Math.round(pixels / snapSize) * snapSize;
        }

        // 픽셀을 시간으로 변환 (기본 5분 = 10px 기준)
        function pixelsToMinutes(pixels) {
            const snappedPixels = Math.round(pixels / 10) * 10; // 기본 10px 단위로 스냅
            return snappedPixels / 2; // 10px = 5분이므로 2로 나누기
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60) + 9; // 09:00부터 시작
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // 시간 컬럼 생성 (30분 단위, 5분=10px 기준)
        function generateTimeSlots() {
            const timeColumn = document.getElementById('timeColumn');
            timeColumn.innerHTML = '';
            
            // 09:00부터 21:00까지 30분 단위로 시간 표시
            // 총 12시간 = 720분 = 1440px
            // 30분 = 60px
            for (let i = 0; i <= 24; i++) { // 24개 슬롯 (09:00 ~ 21:00, 30분 단위)
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                
                const totalMinutes = i * 30; // 0, 30, 60, 90, ... 720분
                const time = minutesToTime(totalMinutes);
                timeSlot.textContent = time;
                
                // 디버깅을 위한 위치 정보 추가
                timeSlot.setAttribute('data-minutes', totalMinutes);
                timeSlot.setAttribute('data-expected-top', totalMinutes * 2); // 5분=10px이므로 분당 2px
                
                timeColumn.appendChild(timeSlot);
            }
            
            console.log('시간 슬롯 생성 완료 - 총 높이:', timeColumn.scrollHeight, 'px');
        }

        // 그리드 라인 생성 (5분 단위, 5분 = 10px)
        function generateGridLines() {
            const dayColumns = document.querySelectorAll('.day-column');
            
            dayColumns.forEach(column => {
                const hourLines = column.querySelector('.hour-lines');
                if (!hourLines) return;
                
                hourLines.innerHTML = '';
                
                // 5분 단위로 라인 생성 (720분 = 12시간, 5분 = 10px)
                for (let minutes = 0; minutes <= 720; minutes += 5) {
                    const line = document.createElement('div');
                    
                    if (minutes % 60 === 0) {
                        line.className = 'hour-line';
                    } else {
                        line.className = 'five-minute-line';
                    }
                    
                    line.style.top = (minutes * 2) + 'px'; // 5분 = 10px이므로 2배
                    hourLines.appendChild(line);
                }
            });
        }

        // 블럭 겹침 확인
        function checkOverlap(column, newTop, newHeight, excludeBlock = null) {
            const existingBlocks = column.querySelectorAll('.schedule-block');
            const newBottom = newTop + newHeight;
            
            for (let block of existingBlocks) {
                if (excludeBlock && block === excludeBlock) continue;
                
                const blockTop = parseInt(block.style.top);
                const blockBottom = blockTop + parseInt(block.style.height);
                
                if ((newTop >= blockTop && newTop < blockBottom) || 
                    (newBottom > blockTop && newBottom <= blockBottom) ||
                    (newTop <= blockTop && newBottom >= blockBottom)) {
                    return true;
                }
            }
            return false;
        }

        // 블럭 생성 (치료 유형에 따라 크기 다름)
        function createBlock(column, columnIndex, top, treatmentType = selectedTreatment) {
            const treatment = treatmentTypes[treatmentType];
            const blockHeight = treatment.height; // 치료 유형에 따른 높이
            
            if (checkOverlap(column, top, blockHeight)) {
                // 겹침으로 인해 생성 실패 시 피드백
                console.log('겹침으로 인해 블럭 생성이 취소되었습니다.');
                
                // 잠시 빨간 표시 효과
                const errorIndicator = document.createElement('div');
                errorIndicator.style.cssText = `
                    position: absolute;
                    left: 6px;
                    right: 6px;
                    top: ${top}px;
                    height: ${blockHeight}px;
                    background: rgba(255, 99, 99, 0.6);
                    border: 2px solid #ff3333;
                    border-radius: 8px;
                    z-index: 15;
                    pointer-events: none;
                    animation: errorPulse 0.6s ease-out;
                `;
                
                column.appendChild(errorIndicator);
                setTimeout(() => {
                    if (errorIndicator.parentElement) {
                        errorIndicator.parentElement.removeChild(errorIndicator);
                    }
                }, 600);
                
                return null;
            }
            
            const block = document.createElement('div');
            block.className = `schedule-block ${treatment.color}`;
            block.style.top = top + 'px';
            block.style.height = blockHeight + 'px';
            
            // 높이에 따라 폰트 크기 조정
            if (blockHeight >= 30) {
                block.style.fontSize = '11px';
            } else if (blockHeight >= 20) {
                block.style.fontSize = '10px';
            } else {
                block.style.fontSize = '9px';
            }
            
            const minutes = pixelsToMinutes(top);
            const startTime = minutesToTime(minutes);
            const endTime = minutesToTime(minutes + treatment.duration);
            
            block.dataset.startTime = startTime;
            block.dataset.endTime = endTime;
            block.dataset.dayIndex = columnIndex;
            block.dataset.treatmentType = treatmentType;
            
            // 블럭 텍스트를 "고정명수 진료명" 형태로 표시
            const patientCount = treatmentType === 'general' ? 3 : 1; // 일반진료: 3명, 영유아검진: 1명
            const blockText = `${patientCount}명 ${treatment.name}`;
            block.textContent = blockText;
            
            // 블럭 클릭 이벤트
            block.addEventListener('click', function(e) {
                if (hasMoved) return;
                
                // 삭제 모드일 때만 삭제
                if (selectedTreatment === 'delete') {
                    block.remove();
                }
                // 다른 모드에서는 클릭으로 삭제하지 않음
            });

            // 블럭 이동 드래그 (삭제 모드가 아닐 때만)
            block.addEventListener('mousedown', function(e) {
                if (selectedTreatment === 'delete') return; // 삭제 모드에서는 드래그 불가
                
                e.preventDefault();
                e.stopPropagation();
                
                isMovingBlock = true;
                movingBlock = block;
                hasMoved = false;
                
                block.style.opacity = '0.5';
                block.style.zIndex = '1000';
                
                // 이동 커서로 변경
                setCursorMove();
            });
            
            column.appendChild(block);
            
            // 새 블럭 생성 후 커서 업데이트
            updateCursor();
            
            return block;
        }

        // 지정된 영역에 겹치는 블럭들을 삭제하는 함수
        function deleteBlocksInArea(column, startY, endY) {
            const areaTop = Math.min(startY, endY);
            const areaBottom = Math.max(startY, endY);
            
            // 컬럼 내의 모든 블럭을 확인
            const blocks = column.querySelectorAll('.schedule-block');
            const blocksToDelete = [];
            
            blocks.forEach(block => {
                const blockTop = parseInt(block.style.top);
                const blockBottom = blockTop + parseInt(block.style.height);
                
                // 영역과 겹치는지 확인 (부분적 겹침도 포함)
                if (!(blockBottom <= areaTop || blockTop >= areaBottom)) {
                    blocksToDelete.push(block);
                }
            });
            
            // 겹치는 블럭들 삭제
            blocksToDelete.forEach(block => {
                block.remove();
            });
            
            console.log(`삭제된 블럭 수: ${blocksToDelete.length}`);
        }

        // 멀티 블럭 생성 (드래그 범위에 치료 유형별 크기로)
        function createMultipleBlocks(column, columnIndex, startY, endY, treatmentType = selectedTreatment) {
            
            const treatment = treatmentTypes[treatmentType];
            const top = Math.min(startY, endY);
            const height = Math.abs(endY - startY);
            
            // 치료 유형별 크기로 블럭 생성
            const blockHeight = treatment.height;
            const blockCount = Math.floor(height / blockHeight);
            const createdBlocks = [];
            
            for (let i = 0; i < blockCount; i++) {
                const blockTop = top + (i * blockHeight);
                const newBlock = createBlock(column, columnIndex, blockTop, treatmentType);
                if (newBlock) {
                    createdBlocks.push(newBlock);
                }
            }
            
            return createdBlocks;
        }

        // 호버 프리뷰 생성/업데이트 함수
        function showHoverPreview(column, mouseY) {
            if (selectedTreatment === 'delete' || isDragging || isMovingBlock) return;
            
            const treatment = treatmentTypes[selectedTreatment];
            const snappedY = snapToPosition(mouseY);
            
            // 기존 프리뷰 제거
            if (hoverPreview && hoverPreview.parentElement) {
                hoverPreview.parentElement.removeChild(hoverPreview);
            }
            
            // 새 프리뷰 생성
            hoverPreview = document.createElement('div');
            hoverPreview.className = 'hover-preview';
            hoverPreview.style.top = snappedY + 'px';
            hoverPreview.style.height = treatment.height + 'px';
            
            // 겹침 체크
            if (checkOverlap(column, snappedY, treatment.height)) {
                hoverPreview.style.background = 'rgba(255, 99, 99, 0.4)';
                hoverPreview.style.borderColor = '#ff6363';
            } else {
                hoverPreview.style.background = 'rgba(128, 128, 128, 0.4)';
                hoverPreview.style.borderColor = '#999';
            }
            
            column.appendChild(hoverPreview);
        }
        
        // 호버 프리뷰 제거 함수
        function hideHoverPreview() {
            if (hoverPreview && hoverPreview.parentElement) {
                hoverPreview.parentElement.removeChild(hoverPreview);
                hoverPreview = null;
            }
        }

        // 커서 변경 함수들
        function updateCursor() {
            const dayColumns = document.querySelectorAll('.day-column');
            const scheduleBlocks = document.querySelectorAll('.schedule-block');
            
            // 휴지통 커서 생성 함수
            function createTrashCursor() {
                const canvas = document.createElement('canvas');
                canvas.width = 20;
                canvas.height = 20;
                const ctx = canvas.getContext('2d');
                
                // 간단한 휴지통 모양 그리기
                ctx.fillStyle = '#ff4444';
                
                // 휴지통 몸체
                ctx.fillRect(4, 7, 12, 10);
                
                // 휴지통 뚜껑
                ctx.fillRect(3, 5, 14, 2);
                
                // 손잡이
                ctx.fillRect(7, 3, 6, 2);
                
                return 'url(' + canvas.toDataURL() + ') 10 10, auto';
            }
            
            const trashCursor = createTrashCursor();
            
            // 선택된 치료 유형에 따라 커서 설정
            if (selectedTreatment === 'delete') {
                console.log('삭제 모드 커서 적용 중...');
                dayColumns.forEach(column => {
                    column.style.setProperty('cursor', trashCursor, 'important');
                });
                scheduleBlocks.forEach(block => {
                    block.style.setProperty('cursor', trashCursor, 'important');
                });
                console.log('삭제 모드 커서 적용 완료 - dayColumns:', dayColumns.length, 'scheduleBlocks:', scheduleBlocks.length);
            } else {
                console.log('생성 모드 커서 적용 중...');
                // 생성 모드 - crosshair 커서
                dayColumns.forEach(column => {
                    column.style.setProperty('cursor', 'crosshair', 'important');
                });
                scheduleBlocks.forEach(block => {
                    block.style.setProperty('cursor', 'move', 'important');
                });
                console.log('생성 모드 커서 적용 완료 - dayColumns:', dayColumns.length, 'scheduleBlocks:', scheduleBlocks.length);
            }
        }

        function setCursorMove() {
            document.body.style.cursor = 'move';
        }

        function resetCursor() {
            document.body.style.cursor = '';
            updateCursor(); // 기본 커서 상태로 복원
        }

        // 진료항목 선택 이벤트
        document.querySelectorAll('.treatment-item').forEach(item => {
            item.addEventListener('click', function() {
                // 모든 라디오 버튼 선택 해제
                document.querySelectorAll('.treatment-radio').forEach(radio => {
                    radio.classList.remove('selected');
                });
                
                // 클릭된 항목 선택
                const radio = this.querySelector('.treatment-radio');
                radio.classList.add('selected');
                
                // 선택된 치료 타입 업데이트
                selectedTreatment = this.dataset.treatment;
                console.log('선택된 진료:', treatmentTypes[selectedTreatment].name);
                
                // 기존 호버 프리뷰 제거 (새로운 치료 유형으로 변경되었으므로)
                hideHoverPreview();
                
                // 커서 업데이트
                console.log('커서 업데이트 시작 - selectedTreatment:', selectedTreatment);
                updateCursor();
                console.log('커서 업데이트 완료');
            });
        });

        // 드래그 이벤트 설정
        document.querySelectorAll('.day-column').forEach((column, columnIndex) => {
            // 호버 프리뷰 이벤트
            column.addEventListener('mousemove', function(e) {
                if (isDragging || isMovingBlock) return;
                
                const rect = column.getBoundingClientRect();
                const rawY = e.clientY - rect.top;
                showHoverPreview(column, rawY);
            });
            
            column.addEventListener('mouseleave', function(e) {
                if (!isDragging && !isMovingBlock) {
                    hideHoverPreview();
                }
            });
            
            column.addEventListener('mousedown', function(e) {
                if (isMovingBlock) return;
                
                if (e.target !== column && !e.target.classList.contains('hour-lines') && 
                    !e.target.classList.contains('hour-line') && !e.target.classList.contains('five-minute-line')) {
                    return;
                }
                
                e.preventDefault();
                isDragging = true;
                currentColumn = column;
                hasMoved = false;
                
                // 드래그 시작 시 호버 프리뷰 제거
                hideHoverPreview();
                
                const rect = column.getBoundingClientRect();
                const rawY = e.clientY - rect.top;
                dragStartY = snapToPosition(rawY);
                
                // 드래그 프리뷰 생성
                if (selectedTreatment === 'delete') {
                    // 삭제 모드용 프리뷰
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'delete-drag-preview';
                    dragPreview.style.left = '4px';
                    dragPreview.style.right = '4px';
                    dragPreview.style.top = dragStartY + 'px';
                    dragPreview.style.height = '10px'; // 최소 높이
                    column.appendChild(dragPreview);
                } else {
                    // 생성 모드용 프리뷰
                    dragPreview = document.createElement('div');
                    dragPreview.className = 'multi-drag-preview';
                    dragPreview.style.left = '4px';
                    dragPreview.style.right = '4px';
                    dragPreview.style.top = dragStartY + 'px';
                    dragPreview.style.height = treatmentTypes[selectedTreatment].height + 'px';
                    column.appendChild(dragPreview);
                }
            });

            // 드래그 중 mousemove는 별도로 처리하지 않음 (전역 이벤트에서 처리)

            column.addEventListener('mouseup', function(e) {
                if (!isDragging || currentColumn !== column) return;
                
                e.preventDefault();
                
                if (selectedTreatment === 'delete') {
                    // 삭제 모드 처리
                    if (hasMoved) {
                        // 드래그로 영역 삭제
                        const rect = column.getBoundingClientRect();
                        const rawEndY = e.clientY - rect.top;
                        const endY = snapToPosition(rawEndY);
                        
                        deleteBlocksInArea(column, dragStartY, endY);
                    }
                    // 클릭 삭제는 개별 블럭 클릭 이벤트에서 처리
                } else {
                    // 생성 모드 처리
                    if (!hasMoved) {
                        // 클릭으로 단일 블럭 생성
                        createBlock(column, columnIndex, dragStartY, selectedTreatment);
                    } else {
                        // 드래그로 멀티 블럭 생성
                        const rect = column.getBoundingClientRect();
                        const rawEndY = e.clientY - rect.top;
                        const endY = snapToPosition(rawEndY);
                        
                        createMultipleBlocks(column, columnIndex, dragStartY, endY, selectedTreatment);
                    }
                }
                
                // 정리
                if (dragPreview) {
                    dragPreview.remove();
                    dragPreview = null;
                }
                isDragging = false;
                currentColumn = null;
                hasMoved = false;
                
                // 드래그 종료 후 마우스 위치에 호버 프리뷰 다시 표시
                setTimeout(() => {
                    const rect = column.getBoundingClientRect();
                    const rawY = e.clientY - rect.top;
                    if (rawY >= 0 && rawY <= rect.height) {
                        showHoverPreview(column, rawY);
                    }
                }, 10);
            });
        });

        // 전역 마우스 이벤트
        document.addEventListener('mousemove', function(e) {
            if (isMovingBlock && movingBlock) {
                e.preventDefault();
                hasMoved = true;
                
                // 블럭 이동 중에는 호버 프리뷰 숨기기
                hideHoverPreview();
                
                // 블럭 이동 로직 (기존과 동일)
                const dayColumns = document.querySelectorAll('.day-column');
                let targetColumn = null;
                
                for (let i = 0; i < dayColumns.length; i++) {
                    const columnRect = dayColumns[i].getBoundingClientRect();
                    if (e.clientX >= columnRect.left && e.clientX <= columnRect.right) {
                        targetColumn = dayColumns[i];
                        break;
                    }
                }
                
                if (targetColumn) {
                    const rect = targetColumn.getBoundingClientRect();
                    const newTop = snapToPosition(e.clientY - rect.top);
                    
                    if (newTop >= 0 && newTop <= 1440) { // 12시간 범위 (720분 * 2 = 1440px)
                        const blockHeight = parseInt(movingBlock.style.height);
                        // 겹침 검사 후 이동 (현재 블럭 제외)
                        if (!checkOverlap(targetColumn, newTop, blockHeight, movingBlock)) {
                            movingBlock.style.top = newTop + 'px';
                            
                            // 시간 데이터 업데이트
                            const minutes = pixelsToMinutes(newTop);
                            const treatmentType = movingBlock.dataset.treatmentType;
                            const duration = treatmentTypes[treatmentType].duration;
                            movingBlock.dataset.startTime = minutesToTime(minutes);
                            movingBlock.dataset.endTime = minutesToTime(minutes + duration);
                        }
                    }
                }
                return;
            }
            
            // 기존 드래그 로직
            if (!isDragging || !currentColumn || !dragPreview) return;
            
            const rect = currentColumn.getBoundingClientRect();
            const rawCurrentY = e.clientY - rect.top;
            
            if (rawCurrentY < 0 || rawCurrentY > rect.height) return;
            
            const currentY = snapToPosition(rawCurrentY);
            
            const threshold = selectedTreatment !== 'delete' ? treatmentTypes[selectedTreatment].height : 10;
            if (Math.abs(currentY - dragStartY) > threshold) {
                hasMoved = true;
            }
            
            const top = Math.min(dragStartY, currentY);
            const height = Math.abs(currentY - dragStartY);
            
            if (dragPreview) {
                dragPreview.style.top = top + 'px';
                if (selectedTreatment === 'delete') {
                    // 삭제 모드에서는 최소 높이 없이 실제 드래그 영역 표시
                    dragPreview.style.height = Math.max(10, height) + 'px';
                } else {
                    // 생성 모드에서는 치료 유형별 최소 높이 적용
                    const minHeight = treatmentTypes[selectedTreatment].height;
                    dragPreview.style.height = Math.max(minHeight, height) + 'px';
                }
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (isMovingBlock && movingBlock) {
                e.preventDefault();
                
                // 이동 완료 처리
                const dayColumns = document.querySelectorAll('.day-column');
                let targetColumn = null;
                let targetColumnIndex = -1;
                
                for (let i = 0; i < dayColumns.length; i++) {
                    const columnRect = dayColumns[i].getBoundingClientRect();
                    if (e.clientX >= columnRect.left && e.clientX <= columnRect.right) {
                        targetColumn = dayColumns[i];
                        targetColumnIndex = i;
                        break;
                    }
                }
                
                if (targetColumn && movingBlock.parentElement !== targetColumn) {
                    const rect = targetColumn.getBoundingClientRect();
                    const newTop = snapToPosition(e.clientY - rect.top);
                    
                    const blockHeight = parseInt(movingBlock.style.height);
                    if (!checkOverlap(targetColumn, newTop, blockHeight, movingBlock)) {
                        movingBlock.parentElement.removeChild(movingBlock);
                        targetColumn.appendChild(movingBlock);
                        movingBlock.style.top = newTop + 'px';
                        movingBlock.dataset.dayIndex = targetColumnIndex;
                        
                        // 시간 데이터 업데이트
                        const minutes = pixelsToMinutes(newTop);
                        const treatmentType = movingBlock.dataset.treatmentType;
                        const duration = treatmentTypes[treatmentType].duration;
                        movingBlock.dataset.startTime = minutesToTime(minutes);
                        movingBlock.dataset.endTime = minutesToTime(minutes + duration);
                    }
                }
                
                movingBlock.style.opacity = '1';
                movingBlock.style.zIndex = '10';
                
                isMovingBlock = false;
                movingBlock = null;
                hasMoved = false;
                
                // 커서 복원
                resetCursor();
                
                // 블럭 이동 완료 후 마우스 위치에 호버 프리뷰 다시 표시
                setTimeout(() => {
                    const dayColumns = document.querySelectorAll('.day-column');
                    for (let column of dayColumns) {
                        const columnRect = column.getBoundingClientRect();
                        if (e.clientX >= columnRect.left && e.clientX <= columnRect.right &&
                            e.clientY >= columnRect.top && e.clientY <= columnRect.bottom) {
                            const rawY = e.clientY - columnRect.top;
                            showHoverPreview(column, rawY);
                            break;
                        }
                    }
                }, 10);
                
                return;
            }
            
            if (isDragging) {
                if (dragPreview) {
                    dragPreview.remove();
                    dragPreview = null;
                }
                isDragging = false;
                currentColumn = null;
                hasMoved = false;
            }
        });

        // 초기화
        generateTimeSlots();
        generateGridLines();
        
        // 초기 커서 설정
        updateCursor();
        
        // 시간 정렬 확인을 위한 디버깅 로그
        console.log('=== 시간 레이블 정렬 확인 ===');
        console.log('5분 = 10px 기준');
        console.log('30분 = 60px 기준');
        console.log('12시간(720분) = 1440px 기준');
        
        // 몇 가지 샘플 시간의 예상 위치 출력
        for (let minutes of [0, 30, 60, 120, 180, 360, 720]) {
            const expectedPx = minutes * 2; // 5분=10px이므로 분당 2px
            const time = minutesToTime(minutes);
            console.log(`${time} (${minutes}분) → ${expectedPx}px`);
        }
        
        console.log('진료 스케줄러가 준비되었습니다. (일반진료: 5분=10px, 영유아검진: 15분=30px)');
        console.log('현재 선택된 진료:', treatmentTypes[selectedTreatment].name);
    </script>
</body>
</html> 